<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FileAMP - Nixie</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0F0B07;
  --nixie:#FF7E33;
  --glow:#FFB366;
  --walnut-dark:#3D2B1F;
  --walnut-light:#8B6F47;
  --brass:#B8860B;
  --display-bg:#1A1410;
  --amber:#FF9F40;
  --amber-dim:#8B6020;
  --text-warm:#D4A06A;
}
html,body{height:100%;overflow:hidden}
body{
  font-family:'Courier New',Courier,monospace;
  background:var(--bg);
  color:var(--text-warm);
  display:flex;flex-direction:column;
  user-select:none;
}

/* Walnut wood grain texture */
.walnut{
  background:
    repeating-linear-gradient(
      87deg,
      transparent,
      transparent 2px,
      rgba(139,111,71,0.06) 2px,
      rgba(139,111,71,0.06) 4px
    ),
    repeating-linear-gradient(
      92deg,
      transparent,
      transparent 5px,
      rgba(61,43,31,0.1) 5px,
      rgba(61,43,31,0.1) 7px
    ),
    linear-gradient(180deg, #3D2B1F 0%, #2A1D14 40%, #3D2B1F 60%, #2A1D14 100%);
}
.walnut-border{
  border:3px solid var(--walnut-dark);
  box-shadow:
    inset 0 0 0 1px rgba(139,111,71,0.3),
    0 0 0 1px rgba(0,0,0,0.5),
    0 2px 8px rgba(0,0,0,0.5);
}

/* Navigation */
nav{
  display:flex;gap:0;
  background:linear-gradient(180deg,#2A1D14,#1A1410);
  border-bottom:2px solid var(--brass);
  flex-shrink:0;
  position:relative;
  z-index:10;
}
nav button{
  flex:1;
  padding:12px 8px;
  background:none;border:none;
  color:var(--amber-dim);
  font-family:inherit;font-size:13px;
  letter-spacing:2px;text-transform:uppercase;
  cursor:pointer;
  transition:all 0.3s;
  position:relative;
}
nav button:hover{color:var(--nixie)}
nav button.active{
  color:var(--nixie);
  text-shadow:0 0 8px var(--nixie),0 0 20px rgba(255,126,51,0.4);
}
nav button.active::after{
  content:'';position:absolute;bottom:-2px;left:20%;right:20%;
  height:2px;
  background:var(--brass);
  box-shadow:0 0 6px var(--brass);
}
nav .brass-accent{
  position:absolute;bottom:0;left:0;right:0;height:2px;
  background:linear-gradient(90deg,transparent,var(--brass),transparent);
}

/* Screens */
.screen{display:none;flex:1;overflow:hidden;flex-direction:column}
.screen.active{display:flex}

/* ===================== HOME SCREEN ===================== */
#home{padding:8px;gap:8px;align-items:center;justify-content:center}
.hifi-panel{
  width:100%;max-width:800px;
  display:flex;flex-direction:column;gap:8px;
  padding:12px;
  border-radius:8px;
}

/* Nixie Time Display */
.nixie-display{
  display:flex;justify-content:center;align-items:center;
  gap:4px;
  padding:16px 20px;
  background:var(--display-bg);
  border-radius:6px;
  border:2px solid rgba(139,111,71,0.4);
  box-shadow:inset 0 2px 10px rgba(0,0,0,0.8),0 1px 0 rgba(139,111,71,0.2);
}
.nixie-digit{
  font-size:clamp(36px,8vw,64px);
  font-weight:bold;
  color:#FF7E33;
  text-shadow:
    0 0 4px #FF7E33,
    0 0 10px #FF7E33,
    0 0 20px rgba(255,126,51,0.6),
    0 0 40px rgba(255,126,51,0.3),
    0 0 60px rgba(255,126,51,0.15);
  position:relative;
  width:clamp(28px,6vw,44px);
  text-align:center;
  line-height:1;
}
.nixie-digit::before{
  content:'';position:absolute;inset:-4px -2px;
  border-radius:4px;
  background:radial-gradient(ellipse at center,rgba(255,126,51,0.08),transparent 70%);
  pointer-events:none;
}
.nixie-tube{
  display:inline-flex;align-items:center;justify-content:center;
  background:radial-gradient(ellipse at center bottom,rgba(255,126,51,0.05),transparent 60%),
    linear-gradient(180deg,rgba(26,20,16,0.9),rgba(15,11,7,0.95));
  border:1px solid rgba(139,111,71,0.25);
  border-radius:6px;
  padding:6px 2px;
  position:relative;
  overflow:hidden;
}
.nixie-tube::after{
  content:'';position:absolute;top:0;left:10%;right:10%;height:30%;
  background:linear-gradient(180deg,rgba(255,255,255,0.03),transparent);
  border-radius:0 0 50% 50%;pointer-events:none;
}
.nixie-colon{
  font-size:clamp(30px,7vw,54px);
  color:#FF7E33;
  text-shadow:0 0 4px #FF7E33,0 0 10px rgba(255,126,51,0.5);
  margin:0 2px;
  line-height:1;
}

/* Now Playing Info */
.now-playing{
  text-align:center;padding:8px;
  color:var(--glow);font-size:14px;
  min-height:44px;display:flex;flex-direction:column;justify-content:center;
}
.now-playing .track-name{
  font-size:16px;font-weight:bold;
  color:var(--nixie);
  text-shadow:0 0 6px rgba(255,126,51,0.4);
  margin-bottom:2px;
}
.now-playing .artist-name{color:var(--amber-dim);font-size:13px}

/* VU Meters */
.vu-meters{
  display:flex;gap:12px;justify-content:center;
  padding:8px 0;
}
.vu-meter{
  width:clamp(120px,25vw,180px);
  height:clamp(80px,16vw,120px);
  background:
    radial-gradient(ellipse at center 80%,rgba(255,179,102,0.04),transparent 60%),
    var(--display-bg);
  border:2px solid rgba(139,111,71,0.4);
  border-radius:8px 8px 4px 4px;
  position:relative;overflow:hidden;
  box-shadow:inset 0 2px 8px rgba(0,0,0,0.6);
}
.vu-meter .label{
  position:absolute;top:4px;left:0;right:0;
  text-align:center;font-size:9px;letter-spacing:3px;
  text-transform:uppercase;color:var(--brass);
}
.vu-meter .scale{
  position:absolute;top:30%;left:8%;right:8%;
  height:40%;
}
.vu-meter .scale-marks{
  position:absolute;bottom:0;left:0;right:0;
  display:flex;justify-content:space-between;
  font-size:7px;color:var(--amber-dim);
  padding:0 4px;
}
.vu-meter .scale-arc{
  position:absolute;bottom:10%;left:10%;right:10%;
  height:60%;
  border-top:1px solid rgba(139,111,71,0.3);
  border-radius:50% 50% 0 0;
}
.vu-needle{
  position:absolute;
  bottom:8%;left:50%;
  width:2px;height:55%;
  background:linear-gradient(to top,var(--brass),#D4A06A);
  transform-origin:bottom center;
  transform:rotate(-40deg);
  transition:transform 0.1s ease-out;
  border-radius:1px 1px 0 0;
  box-shadow:0 0 4px rgba(184,134,11,0.4);
}
.vu-needle::after{
  content:'';position:absolute;bottom:-3px;left:-3px;
  width:8px;height:8px;border-radius:50%;
  background:radial-gradient(circle,var(--brass),#6B4E0A);
  box-shadow:0 0 4px rgba(0,0,0,0.5);
}

/* Tape Deck */
.tape-deck{
  position:relative;
  padding:16px;
  background:
    linear-gradient(180deg,rgba(26,20,16,0.6),rgba(15,11,7,0.8)),
    var(--display-bg);
  border:2px solid rgba(139,111,71,0.35);
  border-radius:8px;
  box-shadow:inset 0 1px 6px rgba(0,0,0,0.5);
  display:flex;align-items:center;justify-content:center;
  min-height:clamp(100px,20vw,140px);
  gap:0;
  cursor:pointer;
}
.tape-deck:hover .deck-label{color:var(--nixie)}
.tape-reel{
  width:clamp(60px,14vw,90px);height:clamp(60px,14vw,90px);
  border-radius:50%;
  border:2px solid var(--walnut-dark);
  background:radial-gradient(circle,#1A1410 30%,#0F0B07 70%);
  position:relative;
  flex-shrink:0;
}
.tape-reel::before{
  content:'';position:absolute;
  top:50%;left:50%;
  width:20%;height:20%;
  border-radius:50%;
  background:var(--brass);
  transform:translate(-50%,-50%);
  box-shadow:0 0 6px rgba(184,134,11,0.4);
}
.reel-spoke{
  position:absolute;top:50%;left:50%;
  width:2px;height:40%;
  background:rgba(139,111,71,0.4);
  transform-origin:bottom center;
}
.tape-path{
  flex:1;min-width:40px;height:4px;
  position:relative;margin:0 -2px;
  display:flex;flex-direction:column;align-items:center;
  justify-content:center;gap:8px;
}
.tape-line{
  width:100%;height:2px;
  background:linear-gradient(90deg,var(--walnut-dark),rgba(139,111,71,0.5),var(--walnut-dark));
  border-radius:1px;
}
.tape-head{
  width:16px;height:20px;
  background:linear-gradient(180deg,var(--brass),#6B4E0A);
  border-radius:2px;
  position:absolute;
  box-shadow:0 0 4px rgba(184,134,11,0.3);
}
.deck-label{
  position:absolute;bottom:6px;left:0;right:0;
  text-align:center;font-size:9px;letter-spacing:3px;
  text-transform:uppercase;color:var(--amber-dim);
  transition:color 0.3s;
}
.play-state{
  position:absolute;top:6px;right:10px;
  font-size:10px;color:var(--nixie);
  text-shadow:0 0 4px rgba(255,126,51,0.5);
  letter-spacing:2px;
}

/* Transport controls */
.transport{
  display:flex;gap:8px;justify-content:center;
  padding:6px 0;
}
.transport button{
  width:48px;height:48px;
  background:linear-gradient(180deg,#2A1D14,#1A1410);
  border:2px solid var(--walnut-dark);
  border-radius:50%;
  color:var(--brass);font-size:18px;
  cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  transition:all 0.2s;
  box-shadow:0 2px 6px rgba(0,0,0,0.4);
}
.transport button:hover{
  border-color:var(--brass);
  color:var(--nixie);
  box-shadow:0 0 10px rgba(184,134,11,0.3);
}
.transport button:active{transform:scale(0.95)}

/* Progress */
.progress-bar{
  width:100%;max-width:600px;
  margin:0 auto;
  display:flex;align-items:center;gap:8px;
  padding:0 12px;
  font-size:11px;color:var(--amber-dim);
}
.progress-track{
  flex:1;height:4px;
  background:var(--display-bg);
  border:1px solid rgba(139,111,71,0.2);
  border-radius:2px;overflow:hidden;
  cursor:pointer;
}
.progress-fill{
  height:100%;width:0%;
  background:linear-gradient(90deg,var(--brass),var(--nixie));
  border-radius:2px;
  transition:width 0.3s;
  box-shadow:0 0 4px rgba(255,126,51,0.3);
}

/* ===================== SETTINGS SCREEN ===================== */
#settings{
  padding:16px;overflow-y:auto;
  flex:1;
}
.settings-container{
  max-width:700px;margin:0 auto;
  font-size:14px;line-height:1.7;
}
.settings-header{
  color:var(--nixie);
  text-shadow:0 0 6px rgba(255,126,51,0.3);
  font-size:16px;
  margin-bottom:12px;
  letter-spacing:3px;
}
.settings-divider{
  border:none;
  height:1px;
  background:linear-gradient(90deg,transparent,var(--brass),transparent);
  margin:12px 0;
  box-shadow:0 0 4px rgba(184,134,11,0.3);
}
.setting-group{margin-bottom:16px}
.setting-group-title{
  color:var(--brass);font-size:13px;
  letter-spacing:2px;text-transform:uppercase;
  margin-bottom:8px;
  text-shadow:0 0 4px rgba(184,134,11,0.2);
}
.setting-row{
  display:flex;justify-content:space-between;
  align-items:center;
  padding:6px 12px;
  color:var(--amber);
  min-height:44px;
}
.setting-row:hover{
  background:rgba(255,126,51,0.04);
  border-radius:4px;
}
.setting-label{color:var(--amber);font-size:14px}
.setting-value{
  color:var(--nixie);font-size:14px;
  text-shadow:0 0 4px rgba(255,126,51,0.3);
}
.tui-switch{
  display:inline-flex;align-items:center;gap:6px;
  cursor:pointer;min-width:48px;min-height:48px;
  justify-content:center;
}
.tui-switch .knob{
  width:36px;height:20px;
  border:1px solid var(--brass);
  border-radius:10px;
  background:var(--display-bg);
  position:relative;
  transition:all 0.3s;
}
.tui-switch .knob::after{
  content:'';position:absolute;top:2px;left:2px;
  width:14px;height:14px;border-radius:50%;
  background:var(--walnut-light);
  transition:all 0.3s;
  box-shadow:0 0 4px rgba(0,0,0,0.3);
}
.tui-switch.on .knob{
  border-color:var(--nixie);
  box-shadow:0 0 6px rgba(255,126,51,0.3);
}
.tui-switch.on .knob::after{
  left:18px;
  background:var(--nixie);
  box-shadow:0 0 6px rgba(255,126,51,0.5);
}
.tui-select{
  background:var(--display-bg);
  border:1px solid var(--walnut-dark);
  color:var(--nixie);
  font-family:inherit;font-size:13px;
  padding:6px 10px;
  border-radius:4px;
  cursor:pointer;
  min-height:36px;
}
.tui-select:focus{
  outline:none;border-color:var(--brass);
  box-shadow:0 0 6px rgba(184,134,11,0.3);
}
.settings-footer{
  text-align:center;
  color:var(--amber-dim);font-size:11px;
  padding:16px 0;
  letter-spacing:1px;
}

/* ===================== BROWSER SCREEN ===================== */
#browser{
  padding:12px;overflow:hidden;
  flex:1;display:flex;flex-direction:column;
}
.browser-header{
  display:flex;gap:8px;align-items:center;
  margin-bottom:10px;flex-shrink:0;
  flex-wrap:wrap;
}
.search-box{
  flex:1;min-width:180px;
  background:var(--display-bg);
  border:1px solid var(--walnut-dark);
  border-radius:4px;
  padding:8px 12px;
  color:var(--nixie);
  font-family:inherit;font-size:14px;
  min-height:44px;
}
.search-box:focus{
  outline:none;
  border-color:var(--brass);
  box-shadow:0 0 6px rgba(184,134,11,0.3);
}
.search-box::placeholder{color:var(--amber-dim)}
.btn-brass{
  background:linear-gradient(180deg,#2A1D14,#1A1410);
  border:1px solid var(--brass);
  color:var(--brass);
  font-family:inherit;font-size:12px;
  padding:8px 16px;
  border-radius:4px;cursor:pointer;
  letter-spacing:1px;text-transform:uppercase;
  transition:all 0.2s;
  min-height:44px;min-width:48px;
}
.btn-brass:hover{
  color:var(--nixie);
  border-color:var(--nixie);
  box-shadow:0 0 8px rgba(255,126,51,0.2);
}
.tree-container{
  flex:1;overflow-y:auto;
  background:var(--display-bg);
  border:1px solid rgba(139,111,71,0.25);
  border-radius:4px;
  padding:10px 14px;
  font-size:14px;
  line-height:1.6;
  scrollbar-width:thin;
  scrollbar-color:var(--walnut-dark) var(--display-bg);
}
.tree-container::-webkit-scrollbar{width:8px}
.tree-container::-webkit-scrollbar-track{background:var(--display-bg)}
.tree-container::-webkit-scrollbar-thumb{background:var(--walnut-dark);border-radius:4px}

.tree-line{
  white-space:nowrap;
  cursor:pointer;
  padding:2px 0;
  min-height:28px;
  display:flex;align-items:center;
}
.tree-line:hover{
  background:rgba(255,126,51,0.06);
  border-radius:2px;
}
.tree-prefix{color:var(--walnut-light);margin-right:0}
.tree-folder{color:var(--brass);text-shadow:0 0 4px rgba(184,134,11,0.2)}
.tree-file{color:var(--amber)}
.tree-file:hover{color:var(--nixie);text-shadow:0 0 4px rgba(255,126,51,0.3)}
.tree-meta{color:var(--amber-dim);font-size:12px;margin-left:8px}
.tree-line.highlight{
  background:rgba(255,126,51,0.1);
  border-radius:2px;
}
.tree-line.highlight .tree-file,
.tree-line.highlight .tree-folder{
  color:var(--nixie);
  text-shadow:0 0 6px rgba(255,126,51,0.4);
}

/* Responsive */
@media(max-width:600px){
  .vu-meters{flex-direction:row;gap:8px}
  .tape-deck{min-height:90px;padding:10px}
  .hifi-panel{padding:8px;gap:6px}
  nav button{padding:10px 4px;font-size:11px;letter-spacing:1px}
  .setting-row{flex-direction:column;align-items:flex-start;gap:4px}
}
@media(min-width:900px){
  .hifi-panel{
    display:grid;
    grid-template-columns:1fr;
    grid-template-rows:auto auto auto auto auto auto;
    gap:10px;
  }
  .vu-meters{gap:20px}
}
</style>
</head>
<body>

<nav>
  <button class="active" data-screen="home">Home</button>
  <button data-screen="settings">Settings</button>
  <button data-screen="browser">Browser</button>
  <span class="brass-accent"></span>
</nav>

<!-- HOME SCREEN -->
<div id="home" class="screen active">
  <div class="hifi-panel walnut walnut-border">
    <!-- Nixie Time Display -->
    <div class="nixie-display">
      <div class="nixie-tube"><span class="nixie-digit" id="min1">0</span></div>
      <div class="nixie-tube"><span class="nixie-digit" id="min2">0</span></div>
      <span class="nixie-colon">:</span>
      <div class="nixie-tube"><span class="nixie-digit" id="sec1">0</span></div>
      <div class="nixie-tube"><span class="nixie-digit" id="sec2">0</span></div>
    </div>

    <!-- Now Playing -->
    <div class="now-playing">
      <div class="track-name" id="trackName">No Track Selected</div>
      <div class="artist-name" id="artistName">Browse your collection</div>
    </div>

    <!-- VU Meters -->
    <div class="vu-meters">
      <div class="vu-meter">
        <span class="label">L</span>
        <div class="scale">
          <div class="scale-arc"></div>
          <div class="scale-marks"><span>-20</span><span>-10</span><span>-5</span><span>0</span><span>+3</span></div>
        </div>
        <div class="vu-needle" id="vuLeft"></div>
      </div>
      <div class="vu-meter">
        <span class="label">R</span>
        <div class="scale">
          <div class="scale-arc"></div>
          <div class="scale-marks"><span>-20</span><span>-10</span><span>-5</span><span>0</span><span>+3</span></div>
        </div>
        <div class="vu-needle" id="vuRight"></div>
      </div>
    </div>

    <!-- Tape Deck -->
    <div class="tape-deck" id="tapeDeck">
      <div class="tape-reel" id="reelLeft">
        <div class="reel-spoke" style="transform:translate(-50%,-100%) rotate(0deg)"></div>
        <div class="reel-spoke" style="transform:translate(-50%,-100%) rotate(120deg)"></div>
        <div class="reel-spoke" style="transform:translate(-50%,-100%) rotate(240deg)"></div>
      </div>
      <div class="tape-path">
        <div class="tape-line"></div>
        <div class="tape-head"></div>
        <div class="tape-line"></div>
      </div>
      <div class="tape-reel" id="reelRight">
        <div class="reel-spoke" style="transform:translate(-50%,-100%) rotate(0deg)"></div>
        <div class="reel-spoke" style="transform:translate(-50%,-100%) rotate(120deg)"></div>
        <div class="reel-spoke" style="transform:translate(-50%,-100%) rotate(240deg)"></div>
      </div>
      <div class="play-state" id="playState">STOP</div>
      <div class="deck-label">Click to Play / Pause</div>
    </div>

    <!-- Transport -->
    <div class="transport">
      <button id="btnPrev" title="Previous">&#9198;</button>
      <button id="btnPlay" title="Play/Pause">&#9654;</button>
      <button id="btnStop" title="Stop">&#9632;</button>
      <button id="btnNext" title="Next">&#9197;</button>
    </div>

    <!-- Progress -->
    <div class="progress-bar">
      <span id="elapsed">00:00</span>
      <div class="progress-track" id="progressTrack">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <span id="remaining">00:00</span>
    </div>
  </div>
</div>

<!-- SETTINGS SCREEN -->
<div id="settings" class="screen">
  <div class="settings-container">
    <div class="settings-header">&#9881; SETTINGS</div>
    <hr class="settings-divider">

    <div class="setting-group">
      <div class="setting-group-title">Playback</div>
      <div class="setting-row">
        <span class="setting-label">Shuffle</span>
        <div class="tui-switch" data-setting="shuffle" onclick="toggleSwitch(this)"><div class="knob"></div></div>
      </div>
      <div class="setting-row">
        <span class="setting-label">Repeat</span>
        <select class="tui-select" data-setting="repeat">
          <option value="off">Off</option>
          <option value="all">All</option>
          <option value="one">One</option>
        </select>
      </div>
      <div class="setting-row">
        <span class="setting-label">Gapless Playback</span>
        <div class="tui-switch on" data-setting="gapless" onclick="toggleSwitch(this)"><div class="knob"></div></div>
      </div>
      <div class="setting-row">
        <span class="setting-label">Crossfade (sec)</span>
        <select class="tui-select" data-setting="crossfade">
          <option value="0">0</option>
          <option value="2">2</option>
          <option value="4">4</option>
          <option value="6">6</option>
          <option value="8">8</option>
        </select>
      </div>
    </div>

    <hr class="settings-divider">

    <div class="setting-group">
      <div class="setting-group-title">Display</div>
      <div class="setting-row">
        <span class="setting-label">VU Meter Sensitivity</span>
        <select class="tui-select" data-setting="vu-sensitivity">
          <option value="low">Low</option>
          <option value="medium" selected>Medium</option>
          <option value="high">High</option>
        </select>
      </div>
      <div class="setting-row">
        <span class="setting-label">Nixie Brightness</span>
        <select class="tui-select" data-setting="brightness">
          <option value="dim">Dim</option>
          <option value="normal" selected>Normal</option>
          <option value="bright">Bright</option>
        </select>
      </div>
      <div class="setting-row">
        <span class="setting-label">Show Tape Deck</span>
        <div class="tui-switch on" data-setting="tape-deck" onclick="toggleSwitch(this)"><div class="knob"></div></div>
      </div>
    </div>

    <hr class="settings-divider">

    <div class="setting-group">
      <div class="setting-group-title">Audio</div>
      <div class="setting-row">
        <span class="setting-label">Output Device</span>
        <select class="tui-select" data-setting="output">
          <option>Default System Output</option>
          <option>Headphones</option>
          <option>External DAC</option>
        </select>
      </div>
      <div class="setting-row">
        <span class="setting-label">Equalizer</span>
        <div class="tui-switch" data-setting="eq" onclick="toggleSwitch(this)"><div class="knob"></div></div>
      </div>
      <div class="setting-row">
        <span class="setting-label">ReplayGain</span>
        <select class="tui-select" data-setting="replaygain">
          <option value="off">Off</option>
          <option value="track">Track</option>
          <option value="album" selected>Album</option>
        </select>
      </div>
    </div>

    <hr class="settings-divider">

    <div class="setting-group">
      <div class="setting-group-title">Library</div>
      <div class="setting-row">
        <span class="setting-label">Scan on Startup</span>
        <div class="tui-switch on" data-setting="scan" onclick="toggleSwitch(this)"><div class="knob"></div></div>
      </div>
      <div class="setting-row">
        <span class="setting-label">Media Folder</span>
        <span class="setting-value">/Media/MP3 Collection</span>
      </div>
    </div>

    <div class="settings-footer">
      FileAMP v1.0 &mdash; Nixie Edition<br>
      Warm analog sound, digital precision
    </div>
  </div>
</div>

<!-- BROWSER SCREEN -->
<div id="browser" class="screen">
  <div class="browser-header">
    <input type="text" class="search-box" id="searchInput" placeholder="Search files...">
    <button class="btn-brass" id="btnPlayAll">Play All</button>
    <button class="btn-brass" id="btnCollapse">Collapse</button>
  </div>
  <div class="tree-container" id="treeContainer"></div>
</div>

<script>
// === FILE TREE DATA ===
const FILE_TREE = {
  name: 'Media', type: 'folder', children: [
    { name: 'MP3 Collection', type: 'folder', children: [
      { name: 'Rock', type: 'folder', children: [
        { name: 'Led Zeppelin', type: 'folder', children: [
          { name: 'Stairway to Heaven.mp3', type: 'file', duration: '08:02', size: '11.2 MB' },
          { name: 'Kashmir.mp3', type: 'file', duration: '08:37', size: '12.1 MB' },
          { name: 'Black Dog.mp3', type: 'file', duration: '04:54', size: '6.9 MB' },
          { name: 'Whole Lotta Love.mp3', type: 'file', duration: '05:34', size: '7.8 MB' },
        ]},
        { name: 'Pink Floyd', type: 'folder', children: [
          { name: 'Comfortably Numb.mp3', type: 'file', duration: '06:22', size: '8.9 MB' },
          { name: 'Wish You Were Here.mp3', type: 'file', duration: '05:34', size: '7.8 MB' },
          { name: 'Time.mp3', type: 'file', duration: '07:06', size: '9.9 MB' },
        ]},
        { name: 'AC DC', type: 'folder', children: [
          { name: 'Thunderstruck.mp3', type: 'file', duration: '04:52', size: '6.8 MB' },
          { name: 'Highway to Hell.mp3', type: 'file', duration: '03:28', size: '4.9 MB' },
          { name: 'Back in Black.mp3', type: 'file', duration: '04:15', size: '6.0 MB' },
        ]},
      ]},
      { name: 'Electronic', type: 'folder', children: [
        { name: 'Daft Punk', type: 'folder', children: [
          { name: 'Around the World.mp3', type: 'file', duration: '07:09', size: '10.0 MB' },
          { name: 'One More Time.mp3', type: 'file', duration: '05:20', size: '7.5 MB' },
          { name: 'Digital Love.mp3', type: 'file', duration: '04:58', size: '7.0 MB' },
          { name: 'Harder Better Faster.mp3', type: 'file', duration: '03:44', size: '5.2 MB' },
        ]},
        { name: 'Kraftwerk', type: 'folder', children: [
          { name: 'Autobahn.mp3', type: 'file', duration: '22:43', size: '31.8 MB' },
          { name: 'The Model.mp3', type: 'file', duration: '03:43', size: '5.2 MB' },
          { name: 'Computer Love.mp3', type: 'file', duration: '07:20', size: '10.3 MB' },
        ]},
        { name: 'Aphex Twin', type: 'folder', children: [
          { name: 'Windowlicker.mp3', type: 'file', duration: '06:07', size: '8.6 MB' },
          { name: 'Avril 14th.mp3', type: 'file', duration: '02:05', size: '2.9 MB' },
        ]},
      ]},
      { name: 'Jazz', type: 'folder', children: [
        { name: 'Miles Davis', type: 'folder', children: [
          { name: 'So What.mp3', type: 'file', duration: '09:22', size: '13.1 MB' },
          { name: 'Blue in Green.mp3', type: 'file', duration: '05:27', size: '7.6 MB' },
          { name: 'All Blues.mp3', type: 'file', duration: '11:33', size: '16.2 MB' },
        ]},
        { name: 'John Coltrane', type: 'folder', children: [
          { name: 'Giant Steps.mp3', type: 'file', duration: '04:46', size: '6.7 MB' },
          { name: 'My Favorite Things.mp3', type: 'file', duration: '13:41', size: '19.2 MB' },
        ]},
      ]},
      { name: 'Classical', type: 'folder', children: [
        { name: 'Bach', type: 'folder', children: [
          { name: 'Cello Suite No 1.mp3', type: 'file', duration: '02:38', size: '3.7 MB' },
          { name: 'Toccata and Fugue.mp3', type: 'file', duration: '09:18', size: '13.0 MB' },
        ]},
      ]},
    ]}
  ]
};

// === STATE ===
let state = {
  playing: false,
  currentTrack: null,
  currentArtist: null,
  currentDuration: 0,
  elapsed: 0,
  playlist: [],
  playlistIndex: -1,
  reelAngle: 0,
  spectrumL: 0,
  spectrumR: 0,
  targetL: 0,
  targetR: 0,
  expandedFolders: new Set(),
};

// === NAVIGATION ===
document.querySelectorAll('nav button').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(btn.dataset.screen).classList.add('active');
  });
});

// === SETTINGS ===
function toggleSwitch(el) {
  el.classList.toggle('on');
}

// === HELPERS ===
function parseDuration(str) {
  const parts = str.split(':').map(Number);
  return parts[0] * 60 + parts[1];
}
function formatTime(sec) {
  const m = Math.floor(sec / 60);
  const s = Math.floor(sec % 60);
  return String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
}
function getArtistFromPath(node, path) {
  // Walk path to find the artist folder (depth 3 in tree: Media > MP3 Collection > Genre > Artist)
  if (path.length >= 4) return path[3];
  if (path.length >= 3) return path[2];
  return '';
}

// === COLLECT ALL FILES ===
function collectFiles(node, path) {
  const currentPath = [...path, node.name];
  let files = [];
  if (node.type === 'file') {
    files.push({ name: node.name, duration: node.duration, size: node.size, path: currentPath });
  }
  if (node.children) {
    for (const child of node.children) {
      files = files.concat(collectFiles(child, currentPath));
    }
  }
  return files;
}
const allFiles = collectFiles(FILE_TREE, []);

// === PLAYBACK ===
function playTrack(file) {
  state.currentTrack = file.name.replace('.mp3', '');
  state.currentArtist = file.path.length >= 4 ? file.path[3] : (file.path.length >= 3 ? file.path[2] : '');
  state.currentDuration = parseDuration(file.duration);
  state.elapsed = 0;
  state.playing = true;
  updateNowPlaying();
}

function playFile(file) {
  state.playlist = [file];
  state.playlistIndex = 0;
  playTrack(file);
}

function playAll() {
  if (allFiles.length === 0) return;
  state.playlist = [...allFiles];
  state.playlistIndex = 0;
  playTrack(state.playlist[0]);
}

function togglePlay() {
  if (state.playlist.length === 0 && allFiles.length > 0) {
    playAll();
    return;
  }
  state.playing = !state.playing;
  updateNowPlaying();
}

function stopPlayback() {
  state.playing = false;
  state.elapsed = 0;
  updateNowPlaying();
}

function nextTrack() {
  if (state.playlist.length === 0) return;
  state.playlistIndex = (state.playlistIndex + 1) % state.playlist.length;
  playTrack(state.playlist[state.playlistIndex]);
}

function prevTrack() {
  if (state.playlist.length === 0) return;
  if (state.elapsed > 3) {
    state.elapsed = 0;
    return;
  }
  state.playlistIndex = (state.playlistIndex - 1 + state.playlist.length) % state.playlist.length;
  playTrack(state.playlist[state.playlistIndex]);
}

function updateNowPlaying() {
  document.getElementById('trackName').textContent = state.currentTrack || 'No Track Selected';
  document.getElementById('artistName').textContent = state.currentArtist || 'Browse your collection';
  document.getElementById('playState').textContent = state.playing ? 'PLAY' : (state.currentTrack ? 'PAUSE' : 'STOP');
  document.getElementById('btnPlay').innerHTML = state.playing ? '&#10074;&#10074;' : '&#9654;';
}

// Transport buttons
document.getElementById('btnPlay').addEventListener('click', togglePlay);
document.getElementById('btnStop').addEventListener('click', stopPlayback);
document.getElementById('btnNext').addEventListener('click', nextTrack);
document.getElementById('btnPrev').addEventListener('click', prevTrack);
document.getElementById('tapeDeck').addEventListener('click', togglePlay);

// Progress click
document.getElementById('progressTrack').addEventListener('click', e => {
  if (state.currentDuration === 0) return;
  const rect = e.currentTarget.getBoundingClientRect();
  const pct = (e.clientX - rect.left) / rect.width;
  state.elapsed = pct * state.currentDuration;
});

// Play All button
document.getElementById('btnPlayAll').addEventListener('click', () => {
  playAll();
  // Switch to home
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.querySelector('nav button[data-screen="home"]').classList.add('active');
  document.getElementById('home').classList.add('active');
});

// === ANIMATION LOOP ===
let lastTime = 0;
function animate(timestamp) {
  const dt = lastTime ? (timestamp - lastTime) / 1000 : 0.016;
  lastTime = timestamp;

  if (state.playing) {
    state.elapsed += dt;
    if (state.elapsed >= state.currentDuration && state.currentDuration > 0) {
      nextTrack();
    }

    // Spectrum simulation
    state.targetL = 0.3 + Math.random() * 0.5;
    state.targetR = 0.3 + Math.random() * 0.5;

    // Reel rotation
    state.reelAngle += dt * 60;
  } else {
    state.targetL = 0;
    state.targetR = 0;
  }

  // Smooth spectrum
  state.spectrumL += (state.targetL - state.spectrumL) * 0.15;
  state.spectrumR += (state.targetR - state.spectrumR) * 0.15;

  // VU meters: -40deg (left) to +40deg (right)
  const vuAngleL = -40 + state.spectrumL * 80;
  const vuAngleR = -40 + state.spectrumR * 80;
  document.getElementById('vuLeft').style.transform = `rotate(${vuAngleL}deg)`;
  document.getElementById('vuRight').style.transform = `rotate(${vuAngleR}deg)`;

  // Nixie time display
  const timeStr = formatTime(state.elapsed);
  document.getElementById('min1').textContent = timeStr[0];
  document.getElementById('min2').textContent = timeStr[1];
  document.getElementById('sec1').textContent = timeStr[3];
  document.getElementById('sec2').textContent = timeStr[4];

  // Progress bar
  const pct = state.currentDuration > 0 ? (state.elapsed / state.currentDuration * 100) : 0;
  document.getElementById('progressFill').style.width = pct + '%';
  document.getElementById('elapsed').textContent = formatTime(state.elapsed);
  document.getElementById('remaining').textContent = state.currentDuration > 0 ? formatTime(state.currentDuration - state.elapsed) : '00:00';

  // Reel rotation
  const reelL = document.getElementById('reelLeft');
  const reelR = document.getElementById('reelRight');
  reelL.style.transform = `rotate(${state.reelAngle}deg)`;
  reelR.style.transform = `rotate(${-state.reelAngle}deg)`;

  requestAnimationFrame(animate);
}
requestAnimationFrame(animate);

// === BROWSER TREE ===
function renderTree() {
  const container = document.getElementById('treeContainer');
  const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
  container.innerHTML = '';
  renderNode(FILE_TREE, container, '', true, [], searchTerm);
}

function renderNode(node, container, prefix, isLast, path, searchTerm) {
  const currentPath = [...path, node.name];
  const isFolder = node.type === 'folder';
  const key = currentPath.join('/');

  // If searching, check if this node or descendants match
  if (searchTerm && !nodeMatches(node, searchTerm)) return false;

  const line = document.createElement('div');
  line.className = 'tree-line';

  const connector = path.length === 0 ? '' : (isLast ? '`-- ' : '|-- ');
  const prefixSpan = document.createElement('span');
  prefixSpan.className = 'tree-prefix';
  prefixSpan.textContent = prefix + connector;

  const nameSpan = document.createElement('span');
  nameSpan.className = isFolder ? 'tree-folder' : 'tree-file';

  if (isFolder) {
    const expanded = state.expandedFolders.has(key) || !!searchTerm;
    nameSpan.textContent = (expanded ? '[-] ' : '[+] ') + node.name + '/';
    line.appendChild(prefixSpan);
    line.appendChild(nameSpan);
    container.appendChild(line);

    line.addEventListener('click', () => {
      if (state.expandedFolders.has(key)) {
        state.expandedFolders.delete(key);
      } else {
        state.expandedFolders.add(key);
      }
      renderTree();
    });

    if (expanded && node.children) {
      const childPrefix = prefix + (path.length === 0 ? '' : (isLast ? '    ' : '|   '));
      let rendered = 0;
      node.children.forEach((child, i) => {
        const isChildLast = i === node.children.length - 1;
        const did = renderNode(child, container, childPrefix, isChildLast, currentPath, searchTerm);
        if (did !== false) rendered++;
      });
    }
  } else {
    nameSpan.textContent = node.name;
    const meta = document.createElement('span');
    meta.className = 'tree-meta';
    meta.textContent = `[${node.duration}] ${node.size}`;

    line.appendChild(prefixSpan);
    line.appendChild(nameSpan);
    line.appendChild(meta);
    container.appendChild(line);

    if (searchTerm && node.name.toLowerCase().includes(searchTerm)) {
      line.classList.add('highlight');
    }

    line.addEventListener('click', () => {
      const file = { name: node.name, duration: node.duration, size: node.size, path: currentPath };
      // Build playlist from sibling files
      const parentPath = currentPath.slice(0, -1);
      const parentNode = findNode(FILE_TREE, parentPath, 0);
      if (parentNode && parentNode.children) {
        state.playlist = parentNode.children
          .filter(c => c.type === 'file')
          .map(c => ({ name: c.name, duration: c.duration, size: c.size, path: [...parentPath, c.name] }));
        state.playlistIndex = state.playlist.findIndex(f => f.name === node.name);
      }
      playTrack(file);
      // Switch to home
      document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.querySelector('nav button[data-screen="home"]').classList.add('active');
      document.getElementById('home').classList.add('active');
    });
  }
  return true;
}

function findNode(tree, path, depth) {
  if (depth >= path.length) return tree;
  if (!tree.children) return null;
  const child = tree.children.find(c => c.name === path[depth]);
  if (!child) return null;
  return findNode(child, path, depth + 1);
}

function nodeMatches(node, term) {
  if (node.name.toLowerCase().includes(term)) return true;
  if (node.children) {
    return node.children.some(c => nodeMatches(c, term));
  }
  return false;
}

// Search
document.getElementById('searchInput').addEventListener('input', renderTree);

// Collapse all
document.getElementById('btnCollapse').addEventListener('click', () => {
  state.expandedFolders.clear();
  renderTree();
});

// Initial expand
state.expandedFolders.add('Media');
state.expandedFolders.add('Media/MP3 Collection');
renderTree();

// === RESPONSIVE ===
const ro = new ResizeObserver(() => {
  // Could adjust layout here if needed
});
ro.observe(document.body);
</script>
</body>
</html>
