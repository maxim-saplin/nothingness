<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FileAMP - AUTOBAHN</title>
<style>
  /* ── Reset & Base ────────────────────────────────────── */
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --faceplate: #1A1A1E;
    --amber: #FF9500;
    --amber-dim: #CC7700;
    --amber-glow: #FF950044;
    --amber-bright: #FFB340;
    --btn-face: #2A2A2E;
    --btn-shadow: #0D0D10;
    --lcd-bg: #0D0D10;
    --metal-hi: #3A3A3E;
    --metal-lo: #141418;
    --text-dim: #885500;
  }

  body {
    margin: 0;
    background: #0a0a0c;
    font-family: "Lucida Console", "Consolas", monospace;
    color: var(--amber);
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    overflow: hidden;
  }

  /* ── Head Unit Shell ─────────────────────────────────── */
  #head-unit {
    width: 480px;
    max-width: 96vw;
    background: var(--faceplate);
    border-radius: 10px;
    padding: 18px 16px 16px;
    box-shadow:
      0 2px 0 var(--metal-hi),
      0 -2px 0 var(--metal-lo),
      inset 0 1px 0 rgba(255,255,255,0.04),
      0 8px 32px rgba(0,0,0,0.7);
    /* Brushed-metal texture */
    background-image:
      repeating-linear-gradient(
        90deg,
        transparent,
        transparent 1px,
        rgba(255,255,255,0.012) 1px,
        rgba(255,255,255,0.012) 2px
      ),
      linear-gradient(180deg, #222226 0%, #1A1A1E 30%, #161619 70%, #1A1A1E 100%);
    position: relative;
  }

  /* ── CD Slot ─────────────────────────────────────────── */
  .cd-slot {
    width: 60%;
    height: 3px;
    margin: 0 auto 12px;
    border-radius: 2px;
    background: #111114;
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.8);
    position: relative;
    overflow: hidden;
  }
  .cd-slot::after {
    content: '';
    position: absolute;
    top: 0; left: -30%;
    width: 30%; height: 100%;
    background: linear-gradient(90deg, transparent, var(--amber-dim), transparent);
    animation: cd-pulse 3s ease-in-out infinite;
  }
  @keyframes cd-pulse {
    0%, 100% { left: -30%; opacity: 0; }
    50% { left: 100%; opacity: 1; }
  }

  /* ── LCD Display ─────────────────────────────────────── */
  .lcd-panel {
    background: var(--lcd-bg);
    border-radius: 4px;
    border: 2px solid #222;
    box-shadow:
      inset 0 2px 8px rgba(0,0,0,0.9),
      0 1px 0 rgba(255,255,255,0.03);
    padding: 12px 14px;
    margin-bottom: 14px;
    position: relative;
    overflow: hidden;
  }
  .lcd-panel::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background:
      repeating-linear-gradient(
        0deg,
        transparent,
        transparent 2px,
        rgba(0,0,0,0.15) 2px,
        rgba(0,0,0,0.15) 4px
      );
    pointer-events: none;
    z-index: 1;
  }

  /* ── LCD Content: Home ───────────────────────────────── */
  .lcd-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 11px;
    color: var(--amber-dim);
    line-height: 1.6;
    position: relative;
    z-index: 2;
  }
  .lcd-title {
    font-size: 16px;
    color: var(--amber);
    text-shadow: 0 0 8px var(--amber-glow);
    letter-spacing: 1px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 65%;
  }
  .lcd-artist {
    font-size: 12px;
    color: var(--amber-dim);
    text-shadow: 0 0 4px rgba(255,149,0,0.2);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .lcd-time {
    font-size: 22px;
    color: var(--amber);
    text-shadow: 0 0 10px var(--amber-glow);
    font-variant-numeric: tabular-nums;
    letter-spacing: 2px;
  }
  .lcd-status {
    font-size: 10px;
    color: var(--text-dim);
    letter-spacing: 1px;
    text-transform: uppercase;
  }

  /* ── Spectrum Bars ───────────────────────────────────── */
  .spectrum-container {
    display: flex;
    gap: 3px;
    align-items: flex-end;
    height: 28px;
    position: relative;
    z-index: 2;
  }
  .spectrum-bar {
    width: 8px;
    min-height: 2px;
    background: var(--amber);
    border-radius: 1px;
    box-shadow: 0 0 4px var(--amber-glow);
    transition: height 0.08s ease-out;
  }
  .spectrum-bar.dim {
    background: var(--amber-dim);
    box-shadow: 0 0 2px rgba(255,149,0,0.15);
  }

  /* ── Progress Bar ────────────────────────────────────── */
  .progress-wrap {
    height: 4px;
    background: #1a1a1a;
    border-radius: 2px;
    margin: 8px 0 4px;
    position: relative;
    z-index: 2;
    cursor: pointer;
  }
  .progress-fill {
    height: 100%;
    background: var(--amber-dim);
    border-radius: 2px;
    width: 0%;
    box-shadow: 0 0 6px var(--amber-glow);
    transition: width 0.3s linear;
  }

  /* ── Buttons Row ─────────────────────────────────────── */
  .btn-row {
    display: flex;
    gap: 8px;
    justify-content: center;
    flex-wrap: wrap;
  }
  .hw-btn {
    min-width: 52px;
    min-height: 48px;
    background: var(--btn-face);
    border: none;
    border-radius: 5px;
    color: var(--amber);
    font-family: inherit;
    font-size: 13px;
    cursor: pointer;
    position: relative;
    box-shadow:
      0 3px 0 var(--btn-shadow),
      0 4px 8px rgba(0,0,0,0.5),
      inset 0 1px 0 rgba(255,255,255,0.06);
    background-image:
      linear-gradient(180deg, #333338 0%, #2A2A2E 40%, #252529 100%);
    transition: transform 0.06s, box-shadow 0.06s;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 6px 10px;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
  }
  .hw-btn:active {
    transform: translateY(2px);
    box-shadow:
      0 1px 0 var(--btn-shadow),
      0 1px 4px rgba(0,0,0,0.4),
      inset 0 1px 0 rgba(255,255,255,0.04);
  }
  .hw-btn:focus-visible {
    outline: 2px solid var(--amber);
    outline-offset: 2px;
  }
  .hw-btn .icon {
    font-size: 18px;
    line-height: 1;
  }
  .hw-btn.play-btn {
    min-width: 64px;
    background-image:
      linear-gradient(180deg, #383838 0%, #2E2E32 40%, #282830 100%);
  }

  /* ── Transport Row ───────────────────────────────────── */
  .transport-row {
    display: flex;
    gap: 8px;
    justify-content: center;
    margin-bottom: 10px;
  }

  /* ── Mode Buttons ────────────────────────────────────── */
  .mode-row {
    display: flex;
    gap: 6px;
    justify-content: center;
  }
  .mode-btn {
    min-width: 48px;
    min-height: 36px;
    font-size: 10px;
    letter-spacing: 0.5px;
    text-transform: uppercase;
  }
  .mode-btn.active {
    color: var(--amber-bright);
    box-shadow:
      0 3px 0 var(--btn-shadow),
      0 4px 8px rgba(0,0,0,0.5),
      inset 0 1px 0 rgba(255,255,255,0.06),
      0 0 8px var(--amber-glow);
  }

  /* ── Volume Row ──────────────────────────────────────── */
  .vol-row {
    display: flex;
    gap: 6px;
    align-items: center;
    justify-content: center;
    margin-top: 10px;
  }
  .vol-label {
    font-size: 10px;
    color: var(--amber-dim);
    letter-spacing: 1px;
    min-width: 44px;
    text-align: center;
  }

  /* ── Screen containers ───────────────────────────────── */
  .screen { display: none; }
  .screen.active { display: block; }

  /* ── TUI (Settings + Browser) ────────────────────────── */
  .tui-panel {
    background: var(--lcd-bg);
    border-radius: 4px;
    border: 2px solid #222;
    box-shadow: inset 0 2px 8px rgba(0,0,0,0.9);
    padding: 12px 14px;
    margin-bottom: 14px;
    font-size: 12px;
    color: var(--amber);
    min-height: 200px;
    max-height: 340px;
    overflow-y: auto;
    position: relative;
  }
  .tui-panel::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background:
      repeating-linear-gradient(
        0deg,
        transparent,
        transparent 2px,
        rgba(0,0,0,0.12) 2px,
        rgba(0,0,0,0.12) 4px
      );
    pointer-events: none;
    z-index: 0;
  }
  .tui-panel > * { position: relative; z-index: 1; }
  .tui-panel::-webkit-scrollbar { width: 6px; }
  .tui-panel::-webkit-scrollbar-track { background: var(--lcd-bg); }
  .tui-panel::-webkit-scrollbar-thumb { background: var(--amber-dim); border-radius: 3px; }

  .tui-header {
    font-size: 13px;
    color: var(--amber-bright);
    text-shadow: 0 0 6px var(--amber-glow);
    border-bottom: 1px solid #333;
    padding-bottom: 6px;
    margin-bottom: 10px;
    letter-spacing: 2px;
    text-transform: uppercase;
  }

  /* ── Settings Rows ───────────────────────────────────── */
  .setting-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 0;
    border-bottom: 1px solid #1a1a1a;
    cursor: pointer;
    min-height: 36px;
  }
  .setting-row:hover {
    background: rgba(255,149,0,0.05);
  }
  .setting-key {
    color: var(--amber-dim);
    font-size: 11px;
    letter-spacing: 1px;
  }
  .setting-val {
    color: var(--amber);
    font-size: 12px;
    text-shadow: 0 0 4px var(--amber-glow);
  }
  .setting-val.on { color: var(--amber-bright); }
  .setting-val.off { color: var(--text-dim); }

  /* ── Browser Tree ────────────────────────────────────── */
  .tree-item {
    padding: 5px 0;
    cursor: pointer;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    min-height: 32px;
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    border-bottom: 1px solid #111;
  }
  .tree-item:hover {
    background: rgba(255,149,0,0.06);
  }
  .tree-item.selected {
    background: rgba(255,149,0,0.12);
    text-shadow: 0 0 6px var(--amber-glow);
  }
  .tree-icon {
    color: var(--amber-dim);
    min-width: 14px;
    text-align: center;
    font-size: 13px;
  }
  .tree-folder { color: var(--amber); }
  .tree-file { color: var(--amber-dim); font-size: 11px; }
  .tree-file .tree-icon { color: var(--text-dim); }
  .tree-meta {
    margin-left: auto;
    color: var(--text-dim);
    font-size: 10px;
    flex-shrink: 0;
  }

  .breadcrumb {
    font-size: 10px;
    color: var(--text-dim);
    margin-bottom: 8px;
    letter-spacing: 1px;
    display: flex;
    align-items: center;
    gap: 4px;
    flex-wrap: wrap;
  }
  .breadcrumb span {
    cursor: pointer;
  }
  .breadcrumb span:hover {
    color: var(--amber);
  }
  .breadcrumb .sep { cursor: default; }

  .browser-actions {
    display: flex;
    gap: 6px;
    margin-bottom: 10px;
  }
  .browser-actions .hw-btn {
    min-height: 34px;
    font-size: 10px;
    letter-spacing: 0.5px;
  }

  .search-wrap {
    margin-bottom: 10px;
    position: relative;
  }
  .search-input {
    width: 100%;
    background: var(--lcd-bg);
    border: 1px solid #333;
    border-radius: 3px;
    color: var(--amber);
    font-family: inherit;
    font-size: 12px;
    padding: 8px 10px 8px 28px;
    outline: none;
  }
  .search-input::placeholder { color: var(--text-dim); }
  .search-input:focus { border-color: var(--amber-dim); }
  .search-icon {
    position: absolute;
    left: 8px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-dim);
    font-size: 12px;
    pointer-events: none;
  }

  /* ── Brand Label ─────────────────────────────────────── */
  .brand-label {
    text-align: center;
    font-size: 8px;
    color: #444;
    letter-spacing: 3px;
    text-transform: uppercase;
    margin-top: 10px;
  }

  /* ── Responsive ──────────────────────────────────────── */
  @media (max-width: 599px) {
    body { align-items: flex-start; padding-top: 8px; }
    #head-unit {
      width: 100vw;
      max-width: 100vw;
      border-radius: 0;
      padding: 10px 10px 12px;
    }
    .lcd-title { font-size: 14px; }
    .lcd-time { font-size: 18px; }
    .hw-btn { min-width: 48px; min-height: 48px; }
    .tui-panel { max-height: 50vh; }
  }

  @media (min-width: 600px) and (max-width: 1024px) {
    #head-unit {
      width: 520px;
      padding: 20px 20px 18px;
    }
  }

  @media (min-width: 1025px) {
    #head-unit {
      width: 520px;
      padding: 22px 24px 20px;
    }
  }
</style>
</head>
<body>

<div id="head-unit">
  <!-- CD Slot -->
  <div class="cd-slot"></div>

  <!-- ════════ HOME SCREEN ════════ -->
  <div id="screen-home" class="screen active">
    <div class="lcd-panel">
      <div class="lcd-row" style="margin-bottom:4px;">
        <span class="lcd-status" id="play-status">STOPPED</span>
        <span class="lcd-status" id="track-num">--/--</span>
      </div>
      <div class="lcd-row" style="margin-bottom:2px;">
        <span class="lcd-title" id="track-title">NO DISC</span>
      </div>
      <div class="lcd-row" style="margin-bottom:8px;">
        <span class="lcd-artist" id="track-artist">INSERT CD</span>
        <span class="lcd-time" id="track-time">--:--</span>
      </div>
      <div class="lcd-row">
        <div class="spectrum-container" id="spectrum"></div>
        <div style="display:flex;gap:8px;">
          <span class="lcd-status" id="shuffle-ind">SHF</span>
          <span class="lcd-status" id="repeat-ind">RPT</span>
        </div>
      </div>
      <div class="progress-wrap" id="progress-wrap">
        <div class="progress-fill" id="progress-fill"></div>
      </div>
    </div>

    <!-- Transport -->
    <div class="transport-row">
      <button class="hw-btn" id="btn-prev" aria-label="Previous"><span class="icon">&#x23EE;</span></button>
      <button class="hw-btn play-btn" id="btn-play" aria-label="Play"><span class="icon">&#x25B6;</span></button>
      <button class="hw-btn" id="btn-next" aria-label="Next"><span class="icon">&#x23ED;</span></button>
    </div>

    <!-- Volume -->
    <div class="vol-row">
      <button class="hw-btn mode-btn" id="btn-vol-down" aria-label="Volume down">VOL-</button>
      <span class="vol-label" id="vol-label">VOL 12</span>
      <button class="hw-btn mode-btn" id="btn-vol-up" aria-label="Volume up">VOL+</button>
    </div>
  </div>

  <!-- ════════ SETTINGS SCREEN ════════ -->
  <div id="screen-settings" class="screen">
    <div class="tui-panel" id="settings-panel">
      <div class="tui-header">SYSTEM SETTINGS</div>
      <div id="settings-list"></div>
    </div>
  </div>

  <!-- ════════ BROWSER SCREEN ════════ -->
  <div id="screen-browser" class="screen">
    <div class="search-wrap">
      <span class="search-icon">&#x1F50D;</span>
      <input class="search-input" id="search-input" type="text" placeholder="Search files..." />
    </div>
    <div class="browser-actions">
      <button class="hw-btn mode-btn" id="btn-back">&#x25C0; BACK</button>
      <button class="hw-btn mode-btn" id="btn-play-all">PLAY ALL</button>
    </div>
    <div class="tui-panel" id="browser-panel">
      <div class="breadcrumb" id="breadcrumb"></div>
      <div id="tree-list"></div>
    </div>
  </div>

  <!-- Mode Navigation -->
  <div class="mode-row" style="margin-top:12px;">
    <button class="hw-btn mode-btn active" data-mode="home">CD</button>
    <button class="hw-btn mode-btn" data-mode="browser">FILES</button>
    <button class="hw-btn mode-btn" data-mode="settings">SETUP</button>
  </div>

  <div class="brand-label">FileAMP&ensp;&bull;&ensp;AUTOBAHN</div>
</div>

<script>
// ── File Tree Data ─────────────────────────────────────
const FILE_TREE = {
  name: 'Media', type: 'folder', children: [
    { name: 'MP3 Collection', type: 'folder', children: [
      { name: 'Rock', type: 'folder', children: [
        { name: 'Led Zeppelin', type: 'folder', children: [
          { name: 'Stairway to Heaven.mp3', type: 'file', duration: '08:02', size: '11.2 MB' },
          { name: 'Kashmir.mp3', type: 'file', duration: '08:37', size: '12.1 MB' },
          { name: 'Black Dog.mp3', type: 'file', duration: '04:54', size: '6.9 MB' },
          { name: 'Whole Lotta Love.mp3', type: 'file', duration: '05:34', size: '7.8 MB' },
        ]},
        { name: 'Pink Floyd', type: 'folder', children: [
          { name: 'Comfortably Numb.mp3', type: 'file', duration: '06:22', size: '8.9 MB' },
          { name: 'Wish You Were Here.mp3', type: 'file', duration: '05:34', size: '7.8 MB' },
          { name: 'Time.mp3', type: 'file', duration: '07:06', size: '9.9 MB' },
        ]},
        { name: 'AC DC', type: 'folder', children: [
          { name: 'Thunderstruck.mp3', type: 'file', duration: '04:52', size: '6.8 MB' },
          { name: 'Highway to Hell.mp3', type: 'file', duration: '03:28', size: '4.9 MB' },
          { name: 'Back in Black.mp3', type: 'file', duration: '04:15', size: '6.0 MB' },
        ]},
      ]},
      { name: 'Electronic', type: 'folder', children: [
        { name: 'Daft Punk', type: 'folder', children: [
          { name: 'Around the World.mp3', type: 'file', duration: '07:09', size: '10.0 MB' },
          { name: 'One More Time.mp3', type: 'file', duration: '05:20', size: '7.5 MB' },
          { name: 'Digital Love.mp3', type: 'file', duration: '04:58', size: '7.0 MB' },
          { name: 'Harder Better Faster.mp3', type: 'file', duration: '03:44', size: '5.2 MB' },
        ]},
        { name: 'Kraftwerk', type: 'folder', children: [
          { name: 'Autobahn.mp3', type: 'file', duration: '22:43', size: '31.8 MB' },
          { name: 'The Model.mp3', type: 'file', duration: '03:43', size: '5.2 MB' },
          { name: 'Computer Love.mp3', type: 'file', duration: '07:20', size: '10.3 MB' },
        ]},
        { name: 'Aphex Twin', type: 'folder', children: [
          { name: 'Windowlicker.mp3', type: 'file', duration: '06:07', size: '8.6 MB' },
          { name: 'Avril 14th.mp3', type: 'file', duration: '02:05', size: '2.9 MB' },
        ]},
      ]},
      { name: 'Jazz', type: 'folder', children: [
        { name: 'Miles Davis', type: 'folder', children: [
          { name: 'So What.mp3', type: 'file', duration: '09:22', size: '13.1 MB' },
          { name: 'Blue in Green.mp3', type: 'file', duration: '05:27', size: '7.6 MB' },
          { name: 'All Blues.mp3', type: 'file', duration: '11:33', size: '16.2 MB' },
        ]},
        { name: 'John Coltrane', type: 'folder', children: [
          { name: 'Giant Steps.mp3', type: 'file', duration: '04:46', size: '6.7 MB' },
          { name: 'My Favorite Things.mp3', type: 'file', duration: '13:41', size: '19.2 MB' },
        ]},
      ]},
      { name: 'Classical', type: 'folder', children: [
        { name: 'Bach', type: 'folder', children: [
          { name: 'Cello Suite No 1.mp3', type: 'file', duration: '02:38', size: '3.7 MB' },
          { name: 'Toccata and Fugue.mp3', type: 'file', duration: '09:18', size: '13.0 MB' },
        ]},
      ]},
    ]}
  ]
};

// ── State ──────────────────────────────────────────────
const state = {
  screen: 'home',
  playing: false,
  volume: 12,
  shuffle: false,
  repeat: false,
  playlist: [],
  trackIndex: -1,
  elapsed: 0,
  totalSeconds: 0,
  // Browser
  browserPath: [FILE_TREE],
  searchQuery: '',
  // Settings
  settings: {
    visualizer: 'Bars',
    barCount: 8,
    shuffle: false,
    repeat: false,
    bassBoost: false,
    gapless: true,
    lcdBrightness: 'High',
    autoPlay: true,
  },
  // Spectrum
  spectrumBars: [],
  spectrumTargets: [],
};

// ── Helpers ────────────────────────────────────────────
function parseDuration(str) {
  const parts = str.split(':').map(Number);
  return parts[0] * 60 + parts[1];
}
function formatTime(sec) {
  const m = Math.floor(sec / 60);
  const s = Math.floor(sec % 60);
  return String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
}
function getAllFiles(node) {
  if (node.type === 'file') return [node];
  if (!node.children) return [];
  return node.children.flatMap(getAllFiles);
}
function getArtist(file) {
  // Walk up FILE_TREE to find the parent folder name
  function find(node, target, path) {
    if (node === target) return path;
    if (node.children) {
      for (const child of node.children) {
        const r = find(child, target, [...path, node]);
        if (r) return r;
      }
    }
    return null;
  }
  const chain = find(FILE_TREE, file, []);
  if (chain && chain.length >= 2) return chain[chain.length - 1].name;
  return '';
}

// ── Screen Navigation ──────────────────────────────────
const modeBtns = document.querySelectorAll('[data-mode]');
function switchScreen(name) {
  state.screen = name;
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('screen-' + name).classList.add('active');
  modeBtns.forEach(b => {
    b.classList.toggle('active', b.dataset.mode === name);
  });
  if (name === 'settings') renderSettings();
  if (name === 'browser') renderBrowser();
}
modeBtns.forEach(b => b.addEventListener('click', () => switchScreen(b.dataset.mode)));

// ── Spectrum Visualizer ────────────────────────────────
const spectrumEl = document.getElementById('spectrum');
const BAR_COUNT = 8;
for (let i = 0; i < BAR_COUNT; i++) {
  const bar = document.createElement('div');
  bar.className = 'spectrum-bar';
  spectrumEl.appendChild(bar);
  state.spectrumBars.push(bar);
  state.spectrumTargets.push(0);
}

let animId = null;
function animateSpectrum() {
  for (let i = 0; i < BAR_COUNT; i++) {
    if (state.playing) {
      state.spectrumTargets[i] += (Math.random() * 26 - state.spectrumTargets[i]) * 0.3;
      if (Math.random() < 0.15) state.spectrumTargets[i] = Math.random() * 28;
    } else {
      state.spectrumTargets[i] *= 0.9;
    }
    const h = Math.max(2, state.spectrumTargets[i]);
    state.spectrumBars[i].style.height = h + 'px';
    state.spectrumBars[i].classList.toggle('dim', h < 8);
  }
  animId = requestAnimationFrame(animateSpectrum);
}
animateSpectrum();

// ── Playback Simulation ────────────────────────────────
let playTimer = null;
function startPlayTimer() {
  stopPlayTimer();
  playTimer = setInterval(() => {
    if (!state.playing) return;
    state.elapsed += 0.5;
    if (state.elapsed >= state.totalSeconds) {
      nextTrack();
      return;
    }
    updateLCD();
  }, 500);
}
function stopPlayTimer() {
  if (playTimer) { clearInterval(playTimer); playTimer = null; }
}

function playTrack(index) {
  if (index < 0 || index >= state.playlist.length) {
    if (state.repeat && state.playlist.length > 0) {
      index = 0;
    } else {
      stopPlayback();
      return;
    }
  }
  state.trackIndex = index;
  const file = state.playlist[index];
  state.totalSeconds = parseDuration(file.duration);
  state.elapsed = 0;
  state.playing = true;
  updateLCD();
  startPlayTimer();
}
function stopPlayback() {
  state.playing = false;
  state.elapsed = 0;
  stopPlayTimer();
  updateLCD();
}
function nextTrack() {
  if (state.shuffle && state.playlist.length > 1) {
    let next;
    do { next = Math.floor(Math.random() * state.playlist.length); } while (next === state.trackIndex);
    playTrack(next);
  } else {
    playTrack(state.trackIndex + 1);
  }
}
function prevTrack() {
  if (state.elapsed > 3) {
    state.elapsed = 0;
    updateLCD();
  } else {
    playTrack(Math.max(0, state.trackIndex - 1));
  }
}

// ── LCD Update ─────────────────────────────────────────
const elTitle = document.getElementById('track-title');
const elArtist = document.getElementById('track-artist');
const elTime = document.getElementById('track-time');
const elStatus = document.getElementById('play-status');
const elTrackNum = document.getElementById('track-num');
const elProgress = document.getElementById('progress-fill');
const elShufInd = document.getElementById('shuffle-ind');
const elRptInd = document.getElementById('repeat-ind');

function updateLCD() {
  if (state.playlist.length === 0 || state.trackIndex < 0) {
    elTitle.textContent = 'NO DISC';
    elArtist.textContent = 'INSERT CD';
    elTime.textContent = '--:--';
    elStatus.textContent = 'STOPPED';
    elTrackNum.textContent = '--/--';
    elProgress.style.width = '0%';
    return;
  }
  const file = state.playlist[state.trackIndex];
  elTitle.textContent = file.name.replace('.mp3', '');
  elArtist.textContent = getArtist(file);
  elTime.textContent = formatTime(state.elapsed);
  elStatus.textContent = state.playing ? 'PLAYING' : 'PAUSED';
  elTrackNum.textContent = String(state.trackIndex + 1).padStart(2, '0') + '/' + String(state.playlist.length).padStart(2, '0');
  const pct = state.totalSeconds > 0 ? (state.elapsed / state.totalSeconds) * 100 : 0;
  elProgress.style.width = pct + '%';
  elShufInd.style.color = state.shuffle ? 'var(--amber)' : 'var(--text-dim)';
  elRptInd.style.color = state.repeat ? 'var(--amber)' : 'var(--text-dim)';
}

// ── Transport Controls ─────────────────────────────────
document.getElementById('btn-play').addEventListener('click', () => {
  if (state.playlist.length === 0) {
    // Load all files and start
    state.playlist = getAllFiles(FILE_TREE);
    state.shuffle = state.settings.shuffle;
    state.repeat = state.settings.repeat;
    playTrack(0);
  } else {
    state.playing = !state.playing;
    if (state.playing) startPlayTimer(); else stopPlayTimer();
    updateLCD();
  }
  updatePlayBtn();
});
document.getElementById('btn-next').addEventListener('click', () => {
  if (state.playlist.length > 0) nextTrack();
});
document.getElementById('btn-prev').addEventListener('click', () => {
  if (state.playlist.length > 0) prevTrack();
});

function updatePlayBtn() {
  document.getElementById('btn-play').querySelector('.icon').innerHTML =
    state.playing ? '&#x23F8;' : '&#x25B6;';
}

// Progress bar click-to-seek
document.getElementById('progress-wrap').addEventListener('click', (e) => {
  if (state.totalSeconds <= 0) return;
  const rect = e.currentTarget.getBoundingClientRect();
  const pct = (e.clientX - rect.left) / rect.width;
  state.elapsed = pct * state.totalSeconds;
  updateLCD();
});

// ── Volume ─────────────────────────────────────────────
const elVolLabel = document.getElementById('vol-label');
document.getElementById('btn-vol-up').addEventListener('click', () => {
  state.volume = Math.min(30, state.volume + 1);
  elVolLabel.textContent = 'VOL ' + state.volume;
});
document.getElementById('btn-vol-down').addEventListener('click', () => {
  state.volume = Math.max(0, state.volume - 1);
  elVolLabel.textContent = 'VOL ' + state.volume;
});

// ── Settings Screen ────────────────────────────────────
const settingsDef = [
  { key: 'visualizer', label: 'VISUALIZER', values: ['Bars', 'Dots', 'Line', 'Off'] },
  { key: 'barCount', label: 'BAR COUNT', values: [4, 6, 8, 10, 12] },
  { key: 'shuffle', label: 'SHUFFLE', values: [false, true] },
  { key: 'repeat', label: 'REPEAT', values: [false, true] },
  { key: 'bassBoost', label: 'BASS BOOST', values: [false, true] },
  { key: 'gapless', label: 'GAPLESS PLAY', values: [false, true] },
  { key: 'lcdBrightness', label: 'LCD BRIGHT', values: ['Low', 'Medium', 'High'] },
  { key: 'autoPlay', label: 'AUTO PLAY', values: [false, true] },
];

function renderSettings() {
  const list = document.getElementById('settings-list');
  list.innerHTML = '';
  settingsDef.forEach(def => {
    const row = document.createElement('div');
    row.className = 'setting-row';
    const keyEl = document.createElement('span');
    keyEl.className = 'setting-key';
    keyEl.textContent = def.label;
    const valEl = document.createElement('span');
    const v = state.settings[def.key];
    if (typeof v === 'boolean') {
      valEl.className = 'setting-val ' + (v ? 'on' : 'off');
      valEl.textContent = v ? 'ON' : 'OFF';
    } else {
      valEl.className = 'setting-val';
      valEl.textContent = String(v);
    }
    row.appendChild(keyEl);
    row.appendChild(valEl);
    row.addEventListener('click', () => {
      const idx = def.values.indexOf(state.settings[def.key]);
      state.settings[def.key] = def.values[(idx + 1) % def.values.length];
      // Sync shuffle/repeat to playback state
      state.shuffle = state.settings.shuffle;
      state.repeat = state.settings.repeat;
      updateLCD();
      renderSettings();
    });
    list.appendChild(row);
  });
}

// ── Browser Screen ─────────────────────────────────────
function currentFolder() {
  return state.browserPath[state.browserPath.length - 1];
}

function renderBreadcrumb() {
  const bc = document.getElementById('breadcrumb');
  bc.innerHTML = '';
  state.browserPath.forEach((node, i) => {
    if (i > 0) {
      const sep = document.createElement('span');
      sep.className = 'sep';
      sep.textContent = ' > ';
      bc.appendChild(sep);
    }
    const span = document.createElement('span');
    span.textContent = node.name;
    if (i < state.browserPath.length - 1) {
      span.addEventListener('click', () => {
        state.browserPath = state.browserPath.slice(0, i + 1);
        state.searchQuery = '';
        document.getElementById('search-input').value = '';
        renderBrowser();
      });
    }
    bc.appendChild(span);
  });
}

function renderBrowser() {
  renderBreadcrumb();
  const list = document.getElementById('tree-list');
  list.innerHTML = '';
  const folder = currentFolder();
  if (!folder.children) return;

  let items = folder.children;

  // Filter by search
  if (state.searchQuery) {
    const q = state.searchQuery.toLowerCase();
    items = items.filter(item => {
      if (item.name.toLowerCase().includes(q)) return true;
      if (item.type === 'folder') {
        return getAllFiles(item).some(f => f.name.toLowerCase().includes(q));
      }
      return false;
    });
  }

  items.forEach(item => {
    const row = document.createElement('div');
    row.className = 'tree-item ' + (item.type === 'folder' ? 'tree-folder' : 'tree-file');

    const icon = document.createElement('span');
    icon.className = 'tree-icon';
    icon.textContent = item.type === 'folder' ? '+' : '#';

    const label = document.createElement('span');
    label.textContent = item.name;

    row.appendChild(icon);
    row.appendChild(label);

    if (item.type === 'file') {
      const meta = document.createElement('span');
      meta.className = 'tree-meta';
      meta.textContent = item.duration + '  ' + item.size;
      row.appendChild(meta);
      row.addEventListener('click', () => {
        // Play this single file, then remaining files in folder
        const files = getAllFiles(folder);
        const idx = files.indexOf(item);
        state.playlist = files;
        state.shuffle = state.settings.shuffle;
        state.repeat = state.settings.repeat;
        playTrack(idx >= 0 ? idx : 0);
        updatePlayBtn();
        switchScreen('home');
      });
    } else {
      const meta = document.createElement('span');
      meta.className = 'tree-meta';
      const count = getAllFiles(item).length;
      meta.textContent = count + ' track' + (count !== 1 ? 's' : '');
      row.appendChild(meta);
      row.addEventListener('click', () => {
        state.browserPath.push(item);
        state.searchQuery = '';
        document.getElementById('search-input').value = '';
        renderBrowser();
      });
    }

    list.appendChild(row);
  });
}

// Browser back button
document.getElementById('btn-back').addEventListener('click', () => {
  if (state.browserPath.length > 1) {
    state.browserPath.pop();
    state.searchQuery = '';
    document.getElementById('search-input').value = '';
    renderBrowser();
  }
});

// Play All button
document.getElementById('btn-play-all').addEventListener('click', () => {
  const files = getAllFiles(currentFolder());
  if (files.length === 0) return;
  state.playlist = files;
  state.shuffle = state.settings.shuffle;
  state.repeat = state.settings.repeat;
  playTrack(0);
  updatePlayBtn();
  switchScreen('home');
});

// Search
document.getElementById('search-input').addEventListener('input', (e) => {
  state.searchQuery = e.target.value;
  renderBrowser();
});

// ── Responsive (ResizeObserver) ────────────────────────
const hu = document.getElementById('head-unit');
const ro = new ResizeObserver(entries => {
  for (const entry of entries) {
    const w = entry.contentRect.width;
    if (w < 400) {
      hu.style.fontSize = '13px';
    } else if (w < 520) {
      hu.style.fontSize = '14px';
    } else {
      hu.style.fontSize = '15px';
    }
  }
});
ro.observe(hu);

// ── Init ───────────────────────────────────────────────
updateLCD();
</script>
</body>
</html>
